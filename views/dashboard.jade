mixin histogram(id, title, data)
    div(id="histogram-" + id)
    script(type="text/javascript").
        var data = [{
            nbinsx: 10,
            x: !{JSON.stringify(data)},
            type: 'histogram'
        }];
        var layout = {
            title: '#{title}',
            xaxis: { title: 'Hours' },
            yaxis: { title: 'Number of Items' },
            barmode: 'overlay',
            bargap: 0.05,
            bargroupgap: 0.3
        };
        Plotly.newPlot('histogram-#{id}', data, layout);

mixin card-flow-table(cards)
    table.table.table-striped.table-condensed
        thead
            tr
                th Name
                th Reaction
                th Lead
                th Cycle
        tbody
            each card in cards
                tr
                    td!=card.name
                    td!=card.flow.reaction
                    td!=card.flow.lead
                    td!=card.flow.cycle

mixin list-time-table(times)
    table.table.table-striped
        thead
            tr
                th Count
                th Mean
                th Median
                if times.min != undefined
                    th Min
                if times.max != undefined
                    th Max
        tbody
            tr
                td!=(times.count || 0).toFixed(0) + ' items'
                td!=(times.mean || 0).toFixed(2) + ' hours'
                td!=(times.median || 0).toFixed(2) + ' hours'
                if times.min != undefined
                    td!=(times.min || 0).toFixed(2) + ' hours'
                if times.max != undefined
                    td!=(times.max || 0).toFixed(2) + ' hours'

mixin metrics(id, title, data)
    div.row
        div.col-md-12
            //if labels
            //    br
            //    each label, index in labels
            //        span.label(style="font-size: 15px; background-color: " + label.color)!=label.name
            //        &nbsp;
            //else
            h2!=title
    if data.flow
        div.row
            div.col-md-12
                h3 Flow Metrics
        div.row
            div.col-md-4
                    +histogram(id + '-reaction', 'Reaction Time', data.flow.reaction.values)
                    +list-time-table(data.flow.reaction)
            div.col-md-4
                    +histogram(id + '-lead', 'Lead Time', data.flow.lead.values)
                    +list-time-table(data.flow.lead)
            div.col-md-4
                    +histogram(id + '-cycle', 'Cycle Time', data.flow.cycle.values)
                    +list-time-table(data.flow.cycle)

    div.row
        div.col-md-12
            h3 List Metrics
    div.row
        each list, listId in data.lists
            if !list.closed
                div.col-md-4
                    +histogram(id + '-' + listId, list.name, list.times.values)
                    +list-time-table(list.times)
    div.row
        div.col-md-12
            +card-flow-table(data.cards)

doctype html
html(lang="en")
    head
        meta(charset="utf-8")

        script(type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js")
        script(type="text/javascript" src="//d3js.org/d3.v3.min.js" charset="utf-8")
        script(type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous")
        script(type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js")
        script(type="text/javascript").
            jQuery(document).ready(function ($) {
                $('ul.nav-tabs').each(function() {
                    $(this).tab('show');
                    $('a:first', $(this)).click();
                });
            });

        link(rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous")
        link(rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous")

        title!=title

        meta(http-equiv="X-UA-Compatible" content="IE=edge")
        meta(name="viewport" content="width=device-width, initial-scale=1")
    body
        div.container-fluid
            div.row
                div.main.col-md-12
                    h1 Trello Analytics
                    ul.nav.nav-tabs(role="tablist")
                        li(role="presentation" class="active"): a(href="#global" aria-controls="global" role="tab" data-toggle="tab") Globals
                        each element, index in data.labelFiltered
                            li(role="presentation" class="active")
                                a(href="#filtered-"+index.replace(',', '-') aria-controls="filtered-#{index.replace(',', '-')}" role="tab" data-toggle="tab")!=element.name
                    div.tab-content
                        div#global.tab-pane.active(role="tabpanel")
                            +metrics('global', 'Global', data.global)

                        each element, index in data.labelFiltered
                            div.tab-pane(id="filtered-"+index.replace(',', '-') role="tabpanel")
                                +metrics(index, element.name, data.labelFiltered[index])

